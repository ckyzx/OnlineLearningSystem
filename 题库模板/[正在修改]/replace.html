<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Replace</title>
    <style type="text/css">
    * {
        margin: 0;
        padding: 0;
    }
    
    html,
    body {
        width: 100%;
        height: 100%;
    }
    
    .container {
        width: 100%;
        height: 90%;
        overflow: hidden;
    }
    
    .textarea {
        width: 100%;
        height: 100%;
    }
    .btn-container{
        padding:5px 15px 0 0;
        text-align: right;
    }
    #replace{width:80px; height: 24px;}
    </style>
    <script type="text/javascript" src="js/js.request.js"></script>
    <script type="text/javascript" src="js/jquery-1.10.1.min.js"></script>
    <script type="text/javascript" src="js/regexp-pattern.js"></script>
    <script type="text/javascript">
    $(function() {
        'use strict';
        var req, dir, fileName;
        var pats, pres;
        var p, p1, p2, txt;
        var replace, clear;

        req = Request.init();
        dir = req.getValue('dir');
        fileName = req.getValue('file');

        replace = function(textarea, oriPat, pat, rep) {
            var txt = textarea.val();
            var sFlag = false, eFlag = false;

            if ($.type(pat) == 'regexp') {
                pat = pat.toString();
                //pat = pat.replace(/\\/g, '\\\\');
                pat = pat.replace(/(\/)/g, '');
                if(pat.indexOf('^') != -1){
                    pat = pat.replace(/(\^)/g, '\\<n\\>');
                    sFlag = true;
                }
                if(pat.indexOf('$') != -1){
                    pat = pat.replace(/(\$)/g, '\\<r\\>');
                    eFlag = true;
                }
                pat = new RegExp(pat, 'g');
            }
            if ($.type(rep) == 'regexp') {
                rep = rep.toString();
                rep = rep.replace(/\/?/g, '');
                rep = rep.replace(/\\?/g, '');
            }
            if(sFlag){
                rep = '<n>' + rep;
            }
            if(eFlag){
                rep += '<r>';
            }
            txt = encodeURIComponent(txt);
            p = /(%0A(%|\d+[\.%]|[A-Za-z][\.%]))/g;
            while(p.test(txt)){
                txt = txt.replace(p, '$2');
            }
            txt = decodeURIComponent(txt);
            txt = txt.replace(pat, rep);
            txt = txt.replace(/(\<r\>\<n\>)/g, '$1\n');
            textarea.val(txt);
        }
        clear = function(textarea){

            var p, txt;

            txt = textarea.val();
            txt = encodeURIComponent(txt)
            p = /(%0A(%|\d+[\.%]|[A-Za-z][\.%]))/g;
            while(p.test(txt)){
                txt = txt.replace(p, '$2');
            }
            txt = decodeURIComponent(txt);

            p = / *(\<r\>\<n\>){2,4} */g;
            while(p.test(txt)){
                txt = txt.replace(p, '<r><n>');
            }

            p = /(分类：|\/\/|题型：)/g
            txt = txt.replace(p, '<r><n><r><n>$1');
            p = /(\d+\.)/g
            txt = txt.replace(p, '<r><n>$1');

            p = / *\<r\>\<n\> */g;
            while(p.test(txt)){
                txt = txt.replace(p, '\n');
            }
            textarea.val(txt);
        }

        $('#replace').on('click', function() {

            var textarea;

            textarea = $('#txt');

            for (var i = 0; i < patterns.length; i++) {
                p = patterns[i];

                txt = $('#txt').val();
                pats = p.pats;
                for (var i1 = 0; i1 < pats.length; i1++) {
                    p1 = pats[i1];

                    pres = p1.pre;
                    pres = pres == undefined ? [] : pres;
                    for (var i2 = 0; i2 < pres.length; i2++) {
                        p2 = pres[i2];

                        replace(textarea, p2.pat, p2.pat, p2.rep);
                    };

                    replace(textarea, p1.pat, p1.pat, p1.rep);
                };
            };

            clear(textarea);
        });

        $.get('/' + dir + '/txt/' + fileName, function(data) {

            var txt;

            txt = data;
            txt = encodeURIComponent(txt).replace(/%0A/g,'<n>\n').replace(/%0D/g, '<r>'); 
            txt = decodeURIComponent(txt) + '<r><n>';
            $('#txt').val(txt);
        });
    });
    </script>
</head>

<body>
    <div class="container">
        <textarea id="txt" class="textarea"></textarea>
    </div>
    <div class="btn-container">
        <button id="replace">替换</button>
    </div>
</body>

</html>
